version: 2.1

orbs:
  browser-tools: circleci/browser-tools@2.1.2
  codecov: codecov/codecov@5.4.3

parameters:
  triggerCommitHash:
    type: string
    default: ""
  isNightly:
    type: boolean
    default: false
  isRelease:
    type: boolean
    default: false

commands:
  bootstrap_repository_command:
    description: "Bootstrap the repository"
    steps:
      - install_ssh_keys_command
      - run:
          name: Disable Corepack
          command: sudo corepack disable
      - run:
          name: Install pnpm
          command: sudo npm i -g pnpm@^10
      - run:
          name: Install dependencies
          command: pnpm install

  install_ssh_keys_command:
    description: "Install SSH keys"
    steps:
      - add_ssh_keys:
          fingerprints:
            - "a0:41:a2:56:c8:7d:3f:29:41:d1:87:92:fd:50:2b:6b"

  npm_login_command:
    description: "Enable interacting with `npm` using an auth token"
    steps:
      - run:
          name: Login to the npm registry using '.npmrc' file
          command: echo "//registry.npmjs.org/:_authToken=\${CKE5_NPM_TOKEN}" > ~/.npmrc

  gpg_credentials_command:
    description: "Setup GPG configuration"
    steps:
      - run:
          name: Setup GPG configuration
          command: |
            #!/bin/bash

            echo "$CKE5_GPG_KEY" | base64 --decode | gpg --import --quiet

  git_credentials_command:
    description: "Setup git configuration"
    steps:
      - gpg_credentials_command
      - run:
          name: Setup git configuration
          command: |
            git config --global user.email "ckeditor-bot@cksource.com"
            git config --global user.name "CKEditorBot"
            git config --global user.signingkey 3F615B600F38B27B
            git config --global commit.gpgsign true
            git config --global tag.gpgSign true

jobs:
  notify_ci_failure:
    docker:
      - image: cimg/node:24.11.0
    parameters:
      hideAuthor:
        type: string
        default: "false"
    steps:
      - checkout
      - bootstrap_repository_command
      - run:
          # In the PRs that comes from forked repositories, we do not share secret variables.
          # Hence, some of the scripts will not be executed.
          name: ðŸ‘¤ Verify if the build was triggered by community - Check if the build should continue
          command: |
            #!/bin/bash

            if [[ -z ${CODECOV_TOKEN} ]];
            then
              circleci-agent step halt
            fi
      - run:
          name: Waiting for other jobs to finish and sending notification on failure
          command: pnpm ckeditor5-dev-ci-circle-workflow-notifier --task "pnpm ckeditor5-dev-ci-notify-circle-status --pipeline-id << pipeline.number >> --hide-author << parameters.hideAuthor >>"
          no_output_timeout: 1h

  validate_and_tests:
    docker:
      - image: cimg/node:24.11.0-browsers
    steps:
      - checkout
      - bootstrap_repository_command
      - browser-tools/install_chrome
      - run:
          name: Execute ESLint
          command: pnpm run lint
      - run:
          name: Run build
          command: pnpm run build
      - run:
          name: Check types of tests
          command: pnpm run test:check:types
      - run:
          name: Run unit tests
          command: pnpm run test
      - run:
          name: Verify the code coverage
          command: |
            #!/bin/bash

            # Create the `nyc` directory.
            mkdir .nyc_output

            # Copy results.
            cp coverage/coverage-final.json .nyc_output

            # Verify results.
            npx nyc check-coverage --branches 100 --functions 100 --lines 100 --statements 100
      - unless:
          # Upload the code coverage results for non-nightly builds only.
          condition: << pipeline.parameters.isNightly >>
          steps:
            - run:
                # In the PRs that comes from forked repositories, we do not share secret variables.
                # Hence, some of the scripts will not be executed.
                name: ðŸ‘¤ Verify if the build was triggered by community - Check if the build should continue
                command: |
                  #!/bin/bash

                  if [[ -z ${CODECOV_TOKEN} ]];
                  then
                    circleci-agent step halt
                  fi
            - codecov/upload:
                files: coverage/lcov.info
                disable_search: true

  release_prepare:
    docker:
      - image: cimg/node:24.11.0
    steps:
      - checkout
      - bootstrap_repository_command
      - run:
          name: Check if packages are ready to be released
          command: npm run release:prepare-packages -- --verbose --compile-only

  trigger_release_process:
    docker:
      - image: cimg/node:24.11.0
    steps:
      - checkout
      - bootstrap_repository_command
      - run:
          name: Verify if the project is ready to release
          command: |
            #!/bin/bash

            # Do not fail if the Node script ends with non-zero exit code.
            set +e

            node scripts/ci/is-project-ready-to-release.js
            EXIT_CODE=$( echo $? )

            if [ ${EXIT_CODE} -eq 1 ];
            then
              circleci-agent step halt
            fi
      - run:
          name: Trigger the release pipeline
          command: pnpm ckeditor5-dev-ci-trigger-circle-build --slug ckeditor/ckeditor5-react --release-branch master

  release_project:
    docker:
      - image: cimg/node:24.11.0
    steps:
      - checkout
      - bootstrap_repository_command
      - run:
          name: Verify the trigger commit from the repository
          command: |
            #!/bin/bash

            CKE5_LATEST_COMMIT_HASH=$( git log -n 1 --pretty=format:%H origin/master )
            CKE5_TRIGGER_COMMIT_HASH=<< pipeline.parameters.triggerCommitHash >>

            if [[ "${CKE5_LATEST_COMMIT_HASH}" != "${CKE5_TRIGGER_COMMIT_HASH}" ]]; then
              echo "There is a newer commit in the repository on the \`#master\` branch. Use its build to start the release."
              circleci-agent step halt
            fi
      - npm_login_command
      - git_credentials_command
      - run:
          name: Verify if a releaser triggered the job
          command: |
            #!/bin/bash

            # Do not fail if the Node script ends with non-zero exit code.
            set +e

            pnpm ckeditor5-dev-ci-is-job-triggered-by-member --job release_approval --organization ckeditor --team ckeditor-5-publishers
            EXIT_CODE=$( echo $? )

            if [ ${EXIT_CODE} -ne 0 ];
            then
              echo "Aborting the release due to failed verification of the approver (no rights to release)."
              circleci-agent step halt
            fi
      - run:
          name: Disable the redundant workflows option
          command: pnpm ckeditor5-dev-ci-circle-disable-auto-cancel-builds --organization ckeditor --repository ckeditor5-react
      - run:
          name: Prepare the new version to release
          command: npm run release:prepare-packages -- --verbose
      - run:
          name: Publish the packages
          command: npm run release:publish-packages -- --verbose
      - run:
          name: Enable the redundant workflows option
          command: pnpm ckeditor5-dev-ci-circle-enable-auto-cancel-builds --organization ckeditor --repository ckeditor5-react
          when: always
      - run:
          name: Pack the "release/" directory (in case of failure)
          command: |
            zip -r ./release.zip ./release
          when: always
      - store_artifacts:
          path: ./release.zip
          when: always

workflows:
  version: 2
  main:
    when:
      and:
        - equal: [ false, << pipeline.parameters.isNightly >> ]
        - equal: [ false, << pipeline.parameters.isRelease >> ]
    jobs:
      - validate_and_tests
      - release_prepare
      - trigger_release_process:
          requires:
            - validate_and_tests
            - release_prepare
          filters:
            branches:
              only:
                - master
      - notify_ci_failure:
          filters:
            branches:
              only:
                - master

  release:
    when:
      and:
        - equal: [ false, << pipeline.parameters.isNightly >> ]
        - equal: [ true, << pipeline.parameters.isRelease >> ]
    jobs:
      - release_approval:
          type: approval
      - release_project:
          requires:
            - release_approval

  nightly:
    when:
      and:
        - equal: [ true, << pipeline.parameters.isNightly >> ]
        - equal: [ false, << pipeline.parameters.isRelease >> ]
    jobs:
      - validate_and_tests
      - notify_ci_failure:
          hideAuthor: "true"
          filters:
            branches:
              only:
                - master
